{% extends "layouts/base.html" %}

{% block title %}Assessment Report{% endblock %}
{% block body_class %}sidebar-mini{% endblock %}

{% block stylesheets %}
{{ super() }}
<!-- Google Fonts & FontAwesome -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- Local CSS -->
<link rel="stylesheet" href="/static/assets/css/select2.min.css">
<link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
<link rel="stylesheet" href="/static/assets/css/mine.css">

<style>
  .no-print { display: block; }
  @media print {
    .no-print { display: none !important; }
    body { background: white; }
    .content-wrapper, .card { box-shadow: none !important; }
    .content-wrapper { padding: 0; }
    footer, .main-footer { display: none !important; }
  }

  .dark-maroon {
    background-color: #800000 !important;
    color: #fff !important;
  }

  .print-header {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-top: 20px;
    text-align: center;
  }
  .print-header img {
    width: 80px;
    height: 80px;
    border-radius: 10px;
    object-fit: contain;
  }
  .print-header-text h1 {
    font-size: 20px;
    margin: 0;
    color: #800000;
  }
  .print-header-text .contact {
    font-size: 13px;
    color: #444;
  }
  .form-info-wrapper {
    width: 90%;
    margin: 20px auto;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }
  .form-info {
    flex: 1;
    font-weight: bold;
    color: #800000;
  }
  .form-info span {
    color: black;
  }
  .student-photo img.student-square-photo {
    width: 130px;
    height: 130px;
    object-fit: contain;
    border: 2px solid #800000;
    border-radius: 5px;
    background: white;
  }
  table {
    width: 90%;
    margin: 20px auto;
    border-collapse: collapse;
    font-size: 20px;
    line-height: 1.5;
  }
  th, td {
    border: 1px solid black;
    padding: 10px;
    text-align: center;
  }
  th {
    background-color: #800000;
    color: white;
  }
  table th:first-child,
  table td:first-child {
    background-color: #800000;
    color: white;
    font-weight: bold;
  }
  table th {
    position: sticky;
    top: 0;
    z-index: 2;
  }
  .print-datetime {
    text-align: right;
    margin: 10px 40px 0 0;
    font-size: 14px;
    font-style: italic;
  }
  .signature-section td {
    vertical-align: top;
    padding: 20px;
    font-size: 16px;
  }
  .gradescale table td {
    padding: 5px 10px;
    font-size: 14px;
  }
  .note {
    font-size: 16px;
    margin-top: 15px;
    margin-left: 5%;
  }
  .grade-scale-small {
    width: 90%;
    margin: 10px auto;
    border-collapse: collapse;
    font-size: 14px;
  }
  .grade-scale-small th, .grade-scale-small td {
    border: 1px solid black;
    padding: 8px;
    text-align: center;
  }
  .grade-scale-small th {
    background-color: #800000;
    color: white;
  }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">

  <!-- Header -->
  <section class="content-header dark-maroon no-print">
    <div class="container-fluid">
      <h1>Printable Scores Report</h1>
    </div>
  </section>

  <section class="content container-fluid">

    <!-- Filter Form -->
    <div class="card no-print">
      <div class="card-header dark-maroon">
        <h3 class="card-title">Filter Report</h3>
      </div>
      <form method="GET" action="{{ url_for('eot_reports_blueprint.vd_eot_reports') }}">
        <div class="card-body">
          <div class="row">
            {% set select_style = "form-control select2" %}
            <!-- Class -->
            <div class="col-md-3">
              <label>Class</label>
              <select name="class_id" class="{{ select_style }}" required>
                <option value="">-- Select Class --</option>
                {% for c in class_list %}
                <option value="{{ c.class_id }}" {% if c.class_id == selected_class_id %}selected{% endif %}>{{ c.class_name }}</option>
                {% endfor %}
              </select>
            </div>
            <!-- Stream -->
            <div class="col-md-3">
              <label>Stream</label>
              <select name="stream_id" class="{{ select_style }}">
                <option value="">-- Select Stream --</option>
                {% for s in streams %}
                <option value="{{ s.stream_id }}" {% if s.stream_id == selected_stream_id %}selected{% endif %}>{{ s.stream_name }}</option>
                {% endfor %}
              </select>
            </div>
            <!-- Study Year -->
            <div class="col-md-3">
              <label>Study Year</label>
              <select name="year_id" class="{{ select_style }}" required>
                <option value="">-- Select Year --</option>
                {% for y in study_years %}
                <option value="{{ y.year_id }}" {% if y.year_id == selected_study_year_id %}selected{% endif %}>{{ y.year_name }}</option>
                {% endfor %}
              </select>
            </div>
            <!-- Term -->
            <div class="col-md-3">
              <label>Term</label>
              <select name="term_id" class="{{ select_style }}" required>
                <option value="">-- Select Term --</option>
                {% for t in terms %}
                <option value="{{ t.term_id }}" {% if t.term_id == selected_term_id %}selected{% endif %}>{{ t.term_name }}</option>
                {% endfor %}
              </select>
            </div>
            <!-- Assessments (multiple) -->
            <div class="col-md-12 mt-2">
              <label>Assessments (Multiple)</label>
              <select name="assessment_name" class="{{ select_style }}" multiple required>
                {% for a in assessments %}
                <option value="{{ a.assessment_name }}" {% if selected_assessment_name and a.assessment_name in selected_assessment_name %}selected{% endif %}>{{ a.assessment_name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="card-footer text-right">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-search"></i> Filter
          </button>
        </div>
      </form>
    </div>

    <!-- Student Selector -->
    <div class="card no-print">
      <div class="card-header dark-maroon">
        <h3 class="card-title">Select Pupil</h3>
      </div>
      <div class="card-body">
        <select id="studentSelect" class="form-control select2">
          <option value="">-- Select Pupil --</option>
          {% set seen = [] %}
          {% for st in reports %}
          {% if st.reg_no not in seen %}
          <option value="{{ st.reg_no }}">{{ st.full_name }}</option>
          {% set _ = seen.append(st.reg_no) %}
          {% endif %}
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Report Display -->
    <div class="card">
      <div class="card-header dark-maroon">
        <h3 class="card-title">Report</h3>
        <button class="btn btn-secondary float-right no-print" onclick="window.print()">
          <i class="fas fa-print"></i> Print
        </button>
      </div>
      <div class="card-body" id="printableReportContainer" style="overflow-x:auto;">
        <p>Select a pupil to view the report.</p>
      </div>
    </div>

  </section>
</div>
{% endblock %}

{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/static/assets/js/select2.min.js"></script>
<script src="/static/assets/js/adminlte.min.js"></script>





<script>
  // Server‑side data
  const allReports = {{ reports | tojson }};
  const subjectNames = {{ subject_names | tojson }};
  const overallResults = {{ overall_results | default([]) | tojson }};
 const badgeImage = "{{ url_for('static', filename='uploads/' ~ (badge_image or 'default-badge.png')) }}";
  function getSubjectClassRank(reports, subject) {
    if (reports.length && reports[0].subject_ranks?.[subject] !== undefined) {
      return reports[0].subject_ranks[subject];
    }
    return '';
  }

  function renderStudentReport(regNo) {
    const container = document.getElementById('printableReportContainer');
    container.innerHTML = '';

    if (!regNo) {
      container.innerHTML = '<p>Please select a pupil to view the report.</p>';
      return;
    }

    const reports = allReports.filter(r => r.reg_no === regNo);
    if (!reports.length) {
      container.innerHTML = '<p>No report data available for this pupil.</p>';
      return;
    }

    const overall = overallResults.find(r => r.reg_no === regNo) || {};
    const student = reports[0];
    const now = new Date();
    const printedAt = `<div class="print-datetime">Printed on: ${now.toLocaleDateString()} at ${now.toLocaleTimeString()}</div>`;

    const header = `
      <div class="print-header">
        <img src="${badgeImage}" 
          onerror="this.src='{{ url_for('static', filename='assets/img/badge_image.jpg') }}'" 
          alt="School Badge" />
        <div class="print-header-text">
          <h1>SACRED HEART GIRLS’ PRIMARY SCHOOL KYAMUSANSALA</h1>
          <div class="contact">P.O.BOX 1759, MASAKA – UGANDA</div>
          <div class="contact">TEL: 0772‑848153 / 0782‑957781</div>
          <div class="contact">
            Home Page: <a href="http://www.shpsk.ac.ug" target="_blank">www.shpsk.ac.ug</a>
          </div>
        </div>
      </div>
      <div class="form-info-wrapper compact-info">
        <div class="form-info">
          <div><strong>PUPIL’S NAME:</strong> <span>${student.full_name}</span></div>
          <div><strong>REG NO:</strong> <span>${student.reg_no}</span>
            ${student.class_name === 'PRIMARY 7' && student.index_number
              ? `&nbsp;<strong>INDEX NO:</strong> <span>${student.index_number}</span>`
              : ''}
          </div>
          <div><strong>CLASS:</strong> <span>${student.class_name}</span>
            &nbsp;<strong>STREAM:</strong> <span>${student.stream_name}</span>
          </div>
          <div><strong>CLASS SIZE:</strong> <span>${student.total_class_size}</span>
            &nbsp;<strong>STREAM SIZE:</strong> <span>${student.total_stream_size}</span>
          </div>
        </div>
        <div class="student-photo">
          ${student.image
            ? `<img src="/static/uploads/${student.image}" class="student-square-photo" alt="Student Photo">`
            : `<span class="text-muted">No Image</span>`}
        </div>
      </div>
    `;

    reports.sort((a, b) => a.assessment_name.localeCompare(b.assessment_name));

    const tableHeader = `
      <table>
        <thead>
          <tr>
            <th>Subject</th>
            ${reports.map(r => `<th>${r.assessment_name}</th>`).join('')}
            <th><small>Subject Average (%)</small></th>
            <th><small>Subject Average (Grade)</small></th>
            <th><small> Class Subject (Rank)  </small></th>
            <th>Comment</th>
          </tr>
          <tr>
            <th></th>
            ${reports.map(() => `<th>Mark</th>`).join('')}
            <th colspan="4"></th>
          </tr>
        </thead>
        <tbody>
          ${subjectNames.map(subject => {
            let total = 0, count = 0;
            reports.forEach(r => {
              const m = parseFloat(r.marks?.[subject]);
              if (!isNaN(m)) { total += m; count++; }
            });
            // Round average to integer (no decimals)
            const avg = count ? Math.round(total / count) : '';
            const avgGrade = overall.subject_average_grades?.[subject] || '';
            const rank = getSubjectClassRank(reports, subject);
            const sc = reports[0].subject_comments?.[subject];
            const comment = sc 
              ? `<small style="font-size: 12px; color: #666;">${sc.text}<em>(${sc.by})</em></small>` 
              : '';

            return `
              <tr>
                <td>${subject}</td>
                ${reports.map(r => {
                  // Round individual marks to integer if present
                  const mark = r.marks?.[subject];
                  const intMark = (mark !== undefined && mark !== null && mark !== '') 
                    ? Math.round(parseFloat(mark))
                    : '';
                  return `<td>${intMark}</td>`;
                }).join('')}
                <td>${avg !== '' ? avg + '%' : ''}</td>
                <td>${avgGrade}</td>
                <td>${rank}</td>
                <td>${comment}</td>
              </tr>`;
          }).join('')}
          <tr><td colspan="${reports.length + 5}"><strong>Summary</strong></td></tr>
          ${[
            ['Aggregate', 'aggregate', 'aggregate'],
            ['Total', 'total_score', 'overall_total'],
            ['Average', 'average_score', 'overall_subject_average'],
            ['Division', 'division', 'division'],
            ['Stream Position', 'stream_position_assessment', 'stream_position'],
            ['Class Position', 'class_position_assessment', 'class_position']
          ].map(([label, rptKey, ovKey]) => `
            <tr>
              <td>${label}</td>
              ${reports.map(r => `<td>${r[rptKey] ?? ''}</td>`).join('')}
              <td colspan="5"><strong>Overall ${label}:</strong> ${overall[ovKey] ?? ''}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;

    const footer = `
      <table class="signature-section" width="90%">
        <tr>
          <td width="50%">
            <strong>CLASS TEACHER:</strong> ${overall.class_teacher || ''}<br><br>
            <em>${overall.classteacher_comment || ''}</em><br><br>
            ${student.class_teacher_sign_image
              ? `<img src="/static/uploads/${student.class_teacher_sign_image}" alt="Class Teacher Signature" style="width:120px; height:auto;" onerror="this.style.display='none';">`
              : ''}
          </td>
          <td width="50%">
            <strong>HEAD TEACHER'S COMMENT:</strong> ${overall.headteacher_comment || ''}<br><br>
            ${student.headmaster_sign_image
              ? `<img src="/static/uploads/${student.headmaster_sign_image}" alt="Head Teacher Signature" style="width:120px; height:auto;" onerror="this.style.display='none';">`
              : ''}
          </td>
        </tr>
      </table>
      <hr>
      <p><strong>REQUIREMENTS (Authorised by Administration)</strong></p>
      <p>I have read the report ............................................................. ( Parent / Guardian's Signature )</p>
      <table class="grade-scale-small">
        <tr>
          <td><strong>Grade Scale:</strong></td>
          {% for g in grade_scale %}
          <td>{{ g.grade_letter }}: {{ g.min_score }}–{{ g.max_score }}</td>
          {% endfor %}
        </tr>
      </table>
      <p class="note">NEXT TERM BEGINS ON : 08‑Sep‑2024</p>
    `;

    container.innerHTML = printedAt + header + tableHeader + footer;
  }

  $(document).ready(() => {
    $('.select2').select2();
    $('#studentSelect').on('change', function() {
      renderStudentReport(this.value);
    });
  });
</script>





        {% endblock %}
