{% extends "layouts/base.html" %}

{% block title %}Assessment Report{% endblock %}
{% block body_class %}sidebar-mini{% endblock %}

{% block stylesheets %}
{{ super() }}
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="/static/assets/css/select2.min.css">
<link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
<link rel="stylesheet" href="/static/assets/css/mine.css">

<style>
  .no-print {
    display: block;
  }
  @media print {
    .no-print {
      display: none !important;
    }
    body {
      background: white;
    }
    .content-wrapper, .card {
      box-shadow: none !important;
    }
    .content-wrapper {
      padding: 0;
    }
  }

  .dark-maroon {
    background-color: #800000 !important;
    color: #fff !important;
  }

  .print-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
    text-align: center;
  }

  .print-header img {
    width: 80px;
    height: 80px;
    border-radius: 10px;
    object-fit: contain;
  }

  .print-header-text h1 {
    margin: 0;
    font-size: 20px;
    color: #800000;
  }

  .print-header-text .contact {
    font-size: 13px;
    color: #444;
  }

  .form-info-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin: 20px auto;
    width: 90%;
  }

  .form-info {
    font-weight: bold;
    color: #800000;
    flex: 1;
  }

  .form-info span {
    color: black;
  }


.student-photo img.student-square-photo {
  width: 130px;
  height: 130px;
  object-fit: contain;           /* Ensures the whole image fits inside */
  border: 2px solid #800000;
  border-radius: 5px;
  background-color: white;       /* Optional: fill space around image */
}




  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 14px;
  }

  th, td {
    border: 1px solid black;
    padding: 5px;
    text-align: center;
  }

  th {
    background-color: #800000;
    color: white;
  }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">

  <section class="content-header dark-maroon no-print">
    <div class="container-fluid">
      <h1>Printable Scores Report</h1>
    </div>
  </section>

  <section class="content container-fluid">

    <div class="card no-print">
      <div class="card-header dark-maroon">
        <h3 class="card-title">Filter Report</h3>
      </div>
      <form method="GET" action="{{ url_for('reports_blueprint.vd_reports_3') }}">
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 form-group">
              <label for="class_id">Class</label>
              <select id="class_id" name="class_id" class="form-control select2" required>
                <option value="">-- Select Class --</option>
                {% for c in class_list %}
                <option value="{{ c.class_id }}" {% if c.class_id == selected_class_id %}selected{% endif %}>
                  {{ c.class_name }}
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3 form-group">
              <label for="stream_id">Stream</label>
              <select id="stream_id" name="stream_id" class="form-control select2">
                <option value="">-- Select Stream --</option>
                {% for s in streams %}
                <option value="{{ s.stream_id }}" {% if s.stream_id == selected_stream_id %}selected{% endif %}>
                  {{ s.stream_name }}
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3 form-group">
              <label for="year_id">Study Year</label>
              <select id="year_id" name="year_id" class="form-control select2" required>
                <option value="">-- Select Year --</option>
                {% for y in study_years %}
                <option value="{{ y.year_id }}" {% if y.year_id == selected_study_year_id %}selected{% endif %}>
                  {{ y.year_name }}
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3 form-group">
              <label for="term_id">Term</label>
              <select id="term_id" name="term_id" class="form-control select2" required>
                <option value="">-- Select Term --</option>
                {% for t in terms %}
                <option value="{{ t.term_id }}" {% if t.term_id == selected_term_id %}selected{% endif %}>
                  {{ t.term_name }}
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-12 form-group">
              <label for="assessment_name">Assessments (Multiple)</label>
              <select id="assessment_name" name="assessment_name" class="form-control select2" multiple required>
                {% for a in assessments %}
                <option value="{{ a.assessment_name }}"
                {% if selected_assessment_name and a.assessment_name in selected_assessment_name %}selected{% endif %}>
                {{ a.assessment_name }}
              </option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
      <div class="card-footer text-right">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-search"></i> Filter
        </button>
      </div>
    </form>
  </div>

  <div class="card no-print">
    <div class="card-header dark-maroon">
      <h3 class="card-title">Select Pupil</h3>
    </div>
    <div class="card-body">
      <select id="studentSelect" class="form-control select2">
        <option value="">-- Select Pupil --</option>
        {% set seen = [] %}
        {% for student in reports %}
        {% if student.reg_no not in seen %}
        <option value="{{ student.reg_no }}">{{ student.full_name }}</option>
        {% set _ = seen.append(student.reg_no) %}
        {% endif %}
        {% endfor %}
      </select>
    </div>
  </div>

  <div class="card">
    <div class="card-header dark-maroon">
      <h3 class="card-title">Report</h3>
      <button class="btn btn-secondary float-right no-print" onclick="window.print()">
        <i class="fas fa-print"></i> Print
      </button>
    </div>
    <div class="card-body" id="printableReportContainer" style="overflow-x:auto;">
      <p>Select a pupil to view the report.</p>
    </div>
  </div>

</section>
</div>
{% endblock %}

{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/static/assets/js/adminlte.min.js"></script>
<script src="/static/assets/js/select2.min.js"></script>

<script>
  const allReports = {{ reports | tojson }};
  const subjectNames = {{ subject_names | tojson }};
  const badgeImage = "{{ url_for('static', filename='uploads/' ~ (badge_image or 'default-badge.png')) }}";

  function renderStudentReport(regNo) {
    const container = document.getElementById('printableReportContainer');
    container.innerHTML = '';
    if (!regNo) {
      container.innerHTML = '<p>Please select a pupil to view the report.</p>';
      return;
    }
    const reps = allReports.filter(r => r.reg_no === regNo);
    if (reps.length === 0) {
      container.innerHTML = '<p>No report data available for this pupil.</p>';
      return;
    }

    const st = reps[0];
    const header = `
    <div class="print-header">
    <img src="${badgeImage}" alt="School Badge" onerror="this.src='{{ url_for('static', filename='assets/img/badge_image.jpg') }}'">
    <div class="print-header-text">
    <h1>SACRED HEART GIRLS’ PRIMARY SCHOOL KYAMUSANSALA</h1>
    <div class="contact">P.O.BOX 1759, MASAKA – UGANDA</div>
    <div class="contact">TEL: 0772‑848153 / 0782‑957781</div>
    <div class="contact">Website: <a href="http://www.shpsk.ac.ug" target="_blank">www.shpsk.ac.ug</a></div>
    </div>
    </div>

    <div class="form-info-wrapper">
    

    <div class="form-info">
  <p>PUPIL’S NAME: <span>${st.full_name}</span></p>
  <p>CLASS: <span>${st.class_name || 'N/A'}</span> STREAM: <span>${st.stream_name || 'N/A'}</span></p>
  <p>CLASS SIZE: <span>${st.total_class_size || 'N/A'}</span></p>
  <p>STREAM POSITION:<span>${st.total_stream_size || 'N/A'}</span></p>
</div>



    <div class="student-photo">
    ${st.image 
      ? `<img src="/static/uploads/${st.image}" class="img-thumbnail student-square-photo">`
      : `<span class="text-muted">No Image</span>`}
      </div>

      </div>`;

      reps.sort((a, b) => a.assessment_name.localeCompare(b.assessment_name));

      const table = `
      <table>
      <thead>
      <tr>
      <th>#</th>
      <th>Assessment</th>
      ${subjectNames.map(s => `<th>${s}</th><th>AGG</th>`).join('')}
      <th>Aggregates</th>
      <th>TTL</th>
      <th>AVG</th>
      <th>DIV</th>
      <th>Stream Pos</th>

      <th>Class POS</th>
      </tr>
      </thead>
      <tbody>
      ${reps.map((r, i) => `
        <tr>
        <td>${i + 1}</td>
        <td>${r.assessment_name}</td>
        ${subjectNames.map(sub => `<td>${r.marks[sub] || ''}</td><td>${r.grades[sub] || ''}</td>`).join('')}
        <td>${r.aggregate || ''}</td>
        <td>${r.total_score || ''}</td>
        <td>${r.average_score || ''}</td>
        <td>${r.division || ''}</td>
        <td>${r.stream_position || ''}</td>

        <td>${r.class_position || ''}</td>  <!-- this shows class position -->

        </tr>`).join('')}
      </tbody>
      </table>`;

      container.innerHTML = header + table;
    }

    $(function() {
      $('.select2').select2();
      $('#studentSelect').on('change', function() {
        renderStudentReport(this.value);
      });
    });
  </script>
  {% endblock %}
